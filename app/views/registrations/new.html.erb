<!-- app/views/registrations/new.html.erb -->
<div data-controller="nik camera" class="min-h-screen bg-gradient-to-br from-orange-50 to-orange-100 py-8 px-4" data-camera-target="container">
  <div class="max-w-2xl mx-auto bg-white rounded-2xl shadow-xl p-8">
    <div class="text-center mb-8">
      <h2 class="text-3xl font-bold text-orange-600 mb-2">Daftar Anggota</h2>
      <p class="text-gray-600">Lengkapi formulir pendaftaran di bawah ini</p>
    </div>

    <% if @member.errors.any? %>
      <div class="bg-red-50 border-l-4 border-red-500 rounded-lg p-4 mb-6">
        <div class="flex items-start">
          <svg class="w-6 h-6 text-red-500 mr-3 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
          </svg>
          <div class="flex-1">
            <h3 class="text-red-800 font-bold mb-2">Pendaftaran Gagal</h3>
            <ul class="list-disc list-inside text-sm text-red-700 space-y-1">
              <% @member.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        </div>
      </div>
    <% end %>

    <%= form_with model: @member, url: registrations_path, local: true, multipart: true, class: "space-y-6" do |f| %>
      
      <!-- Nama -->
      <div>
        <%= f.label :name, "Nama Lengkap", class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <%= f.text_field :name, required: true, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200" %>
      </div>

      <!-- No HP -->
      <div>
        <%= f.label :phone, 'Nomor HP', class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <%= f.telephone_field :phone, required: true, placeholder: "081234567890", pattern: "08[0-9]{8,11}", inputmode: "numeric", class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200" %>
        <p class="text-xs text-gray-500 mt-1">Format: 08xx (contoh: 081234567890)</p>
      </div>

      <!-- NIK -->
      <div>
        <%= f.label :nik, 'NIK (Nomor Induk Kependudukan)', class: "block text-sm font-semibold text-gray-700 mb-2" %>
        <%= f.text_field :nik, required: true, placeholder: "16 digit NIK", maxlength: "16", inputmode: "numeric", pattern: "[0-9]*", data: { nik_target: 'nik', action: 'input->nik#onInput' }, class: "w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200 font-mono" %>
      </div>

      <!-- Deteksi NIK -->
      <div class="bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-5">
        <h3 class="text-lg font-bold text-orange-700 mb-4 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          Informasi dari NIK
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div class="bg-white rounded-lg p-3">
            <span class="text-xs font-semibold text-gray-500 uppercase">Provinsi</span>
            <p class="text-sm font-medium text-gray-800 mt-1" data-nik-target="prov">—</p>
          </div>
          <div class="bg-white rounded-lg p-3">
            <span class="text-xs font-semibold text-gray-500 uppercase">Kab/Kota</span>
            <p class="text-sm font-medium text-gray-800 mt-1" data-nik-target="reg">—</p>
          </div>
          <div class="bg-white rounded-lg p-3">
            <span class="text-xs font-semibold text-gray-500 uppercase">Kecamatan</span>
            <p class="text-sm font-medium text-gray-800 mt-1" data-nik-target="dis">—</p>
          </div>
          <div class="bg-white rounded-lg p-3">
            <span class="text-xs font-semibold text-gray-500 uppercase">Tanggal Lahir</span>
            <p class="text-sm font-medium text-gray-800 mt-1" data-nik-target="birth">—</p>
          </div>
          <div class="bg-white rounded-lg p-3 md:col-span-2">
            <span class="text-xs font-semibold text-gray-500 uppercase">Jenis Kelamin</span>
            <p class="text-sm font-medium text-gray-800 mt-1" data-nik-target="gender">—</p>
          </div>
        </div>
      </div>

      <!-- Alamat Domisili -->
      <div class="space-y-4 bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-200 rounded-xl p-6">
        <h3 class="text-lg font-bold text-orange-700 mb-1">Alamat Domisili</h3>
        <p class="text-xs text-gray-600 mb-3">Jika domisili Anda sekarang berbeda dengan data KTP, mohon diisi dengan alamat terakhir Anda.</p>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Provinsi</label>
          <select name="member[dom_area2_code]" data-action="change->nik#loadRegencies" data-nik-target="domProv" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200 bg-white">
            <option value="">-- Pilih Provinsi --</option>
            <% Wilayah.provinsis.order(:code_norm).each do |p| %>
              <option value="<%= p.code_norm %>"><%= p.name %></option>
            <% end %>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Kabupaten/Kota</label>
          <select name="member[dom_area4_code]" data-action="change->nik#loadDistricts" data-nik-target="domReg" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200 bg-white">
            <option value="">-- Pilih Kab/Kota --</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Kecamatan</label>
          <select name="member[dom_area6_code]" data-action="change->nik#loadVillages" data-nik-target="domDis" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200 bg-white">
            <option value="">-- Pilih Kecamatan --</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Kelurahan/Desa</label>
          <select name="member[dom_area10_code]" data-nik-target="domVil" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200 bg-white">
            <option value="">-- Pilih Kelurahan/Desa --</option>
          </select>
        </div>

        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">Alamat Lengkap</label>
          <textarea name="member[dom_address]" rows="3" placeholder="Nama jalan, nomor rumah, RT/RW, patokan, dsb." class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition duration-200"></textarea>
        </div>
      </div>

      <!-- Upload Foto KTP -->
      <div>
        <%= f.label :ktp_photo, class: "block text-sm font-semibold text-gray-700 mb-2" do %>
          Foto KTP <span class="text-red-500">*</span>
        <% end %>
        <div class="relative border-2 border-dashed border-orange-300 rounded-lg p-6 hover:border-orange-500 transition duration-200 bg-orange-50 space-y-3">
          <%= f.file_field :ktp_photo, accept: 'image/*', required: true, capture: 'environment', class: "w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600 file:cursor-pointer cursor-pointer", data: { camera_target: 'ktpInput' } %>
          <div class="flex items-center gap-2">
            <button type="button" class="inline-flex items-center gap-2 bg-orange-600 text-white text-sm font-semibold px-3 py-2 rounded-lg hover:bg-orange-700" data-action="camera#openKtp">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c2.485 0 4.5 2.015 4.5 4.5S14.485 14 12 14s-4.5-2.015-4.5-4.5S9.515 5 12 5Zm0-3c-4.136 0-7.5 3.364-7.5 7.5S7.864 17 12 17s7.5-3.364 7.5-7.5S16.136 2 12 2Z"/></svg>
              Ambil pakai kamera
            </button>
            <span class="text-xs text-gray-500">Atau pilih file di atas</span>
          </div>
          <img data-camera-target="ktpPreview" alt="Preview KTP" class="hidden max-h-40 rounded-md border" />
          <p class="text-xs text-gray-500">Format: JPG/PNG, maksimal 5MB</p>
        </div>
      </div>

      <!-- Upload Foto Selfie -->
      <div>
        <%= f.label :selfie_photo, class: "block text-sm font-semibold text-gray-700 mb-2" do %>
          Foto Selfie (untuk KTA) <span class="text-red-500">*</span>
        <% end %>
        <p class="text-xs text-gray-500 mb-2">Pastikan foto terbaik dan jelas untuk ditampilkan di KTA Anda</p>
        <div class="relative border-2 border-dashed border-orange-300 rounded-lg p-6 hover:border-orange-500 transition duration-200 bg-orange-50 space-y-3">
          <%= f.file_field :selfie_photo, accept: 'image/*', required: true, capture: 'user', class: "w-full text-sm text-gray-600 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm font-semibold file:bg-orange-500 file:text-white hover:file:bg-orange-600 file:cursor-pointer cursor-pointer", data: { camera_target: 'selfieInput' } %>
          <div class="flex items-center gap-2">
            <button type="button" class="inline-flex items-center gap-2 bg-orange-600 text-white text-sm font-semibold px-3 py-2 rounded-lg hover:bg-orange-700" data-action="camera#openSelfie">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 5c2.485 0 4.5 2.015 4.5 4.5S14.485 14 12 14s-4.5-2.015-4.5-4.5S9.515 5 12 5Zm0-3c-4.136 0-7.5 3.364-7.5 7.5S7.864 17 12 17s7.5-3.364 7.5-7.5S16.136 2 12 2Z"/></svg>
              Ambil pakai kamera
            </button>
            <span class="text-xs text-gray-500">Atau pilih file di atas</span>
          </div>
          <img data-camera-target="selfiePreview" alt="Preview Selfie" class="hidden max-h-40 rounded-md border" />
          <p class="text-xs text-gray-500">Format: JPG/PNG, maksimal 5MB</p>
        </div>
      </div>

      <!-- Submit Button -->
      <div class="pt-4">
        <%= f.submit 'Daftar Sekarang', class: "w-full bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-4 px-6 rounded-lg hover:from-orange-600 hover:to-orange-700 focus:outline-none focus:ring-4 focus:ring-orange-300 transition duration-200 transform hover:scale-[1.02] active:scale-[0.98] shadow-lg" %>
      </div>

    <% end %>
  </div>

  <!-- Modal Camera Overlay -->
  <div class="hidden fixed inset-0 z-50 bg-black/70 backdrop-blur-sm flex items-center justify-center p-4" data-camera-target="modal" aria-modal="true" role="dialog">
    <div class="w-full max-w-md bg-white rounded-2xl shadow-2xl overflow-hidden">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="text-sm font-semibold text-gray-700" data-camera-target="modeLabel">Mode</h3>
        <button type="button" class="text-gray-500 hover:text-gray-700" data-action="camera#closeModal">Tutup</button>
      </div>
        <div class="relative bg-black" style="aspect-ratio:3/4" data-camera-target="wrap">
        <video class="w-full h-full object-cover" data-camera-target="video"></video>
          <div data-camera-target="guide" class="absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 border-2 border-orange-400 rounded-xl pointer-events-none shadow-[0_0_0_9999px_rgba(0,0,0,0.45)]"></div>
      </div>
      <div class="p-4 flex items-center justify-between gap-3">
        <button type="button" class="px-3 py-2 rounded-lg text-sm font-semibold bg-gray-100 hover:bg-gray-200" data-action="camera#closeModal">Batal</button>
        <button type="button" class="px-4 py-2 rounded-lg text-sm font-semibold text-white bg-orange-600 hover:bg-orange-700" data-action="camera#capture">Ambil</button>
      </div>
      <canvas data-camera-target="canvas" class="hidden"></canvas>
    </div>
  </div>
</div>